<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EasyRent – Demo</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    :root{--accent:#007bff;--green:#28a745;}
    body{font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:#f4f6f8; color:#222;}
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px;}
    header.site-header{background:linear-gradient(135deg,var(--accent),#0056b3);color:#fff;padding:36px 0;text-align:center}
    header.site-header h1{margin:0;font-size:32px;letter-spacing:0.5px}
    header.site-header p{margin:6px 0 0;opacity:0.95}

    .controls{background:#fff;padding:14px;border-bottom:1px solid #e6e9ed;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .controls input[type="text"], .controls input[type="number"], .controls select{padding:8px 10px;border:1px solid #d7dbe0;border-radius:6px}
    .controls .btn{padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
    .btn-apply{background:var(--green);color:#fff}
    .btn-reset{background:#6c757d;color:#fff}
    .sort-buttons{display:inline-flex;gap:8px;align-items:center}
    .sort-buttons button{border-radius:6px;padding:7px 10px;border:none;color:#fff;cursor:pointer}
    .sort-asc{background:#28a745}
    .sort-desc{background:#dc3545}
    .tabs{background:#3a3f44;padding:12px;text-align:center}
    .tabs button{background:#5a6166;color:#fff;border:none;padding:8px 14px;border-radius:6px;margin:0 6px;cursor:pointer}
    .tabs button.active{background:var(--green);}

    main .content{display:grid;grid-template-columns: 1fr 360px;gap:18px;padding:18px 0}
    /* left: listings, right: map */
    #listings{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(20,30,40,0.06);display:flex;flex-direction:column}
    .imgwrap{height:160px;overflow:hidden}
    .imgwrap img{width:100%;height:100%;object-fit:cover;display:block}
    .card-body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .meta{font-size:13px;color:#6b7280}
    .title{font-weight:600;margin:0}
    .price{color:var(--accent);font-weight:700}
    .card-actions{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .view{background:#0d6efd;color:#fff;padding:7px 10px;border-radius:6px;text-decoration:none}
    .fav{background:none;border:none;font-size:20px;cursor:pointer}

    #map{height:640px;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,40,0.06);overflow:hidden}

    .controls-bottom{display:flex;align-items:center;gap:10px;margin-top:6px}
    .msg{grid-column:1/-1;text-align:center;padding:36px;background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(20,30,40,0.03)}
    .load-more{display:block;margin:18px auto;padding:10px 20px;border-radius:10px;border:none;background:#007bff;color:#fff;cursor:pointer}
    @media (max-width:980px){
      main .content{grid-template-columns:1fr; }
      #map{height:360px;margin-top:12px}
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="wrap">
      <h1>EasyRent (Demo)</h1>
      <p>Φίλτρα, αγαπημένα, ταξινόμηση, map — όλα λειτουργικά</p>
    </div>
  </header>

  <div class="controls wrap" style="gap:12px;">
    <input type="text" id="q" placeholder="Αναζήτηση περιοχή / τίτλος..." list="areas" style="flex:1;min-width:170px" />
    <datalist id="areas">
      <option value="Αθήνα">
      <option value="Θεσσαλονίκη">
      <option value="Πάτρα">
      <option value="Ηράκλειο">
      <option value="Λάρισα">
      <option value="Βόλος">
      <option value="Ιωάννινα">
      <option value="Χανιά">
      <option value="Ρόδος">
      <option value="Καλαμάτα">
      <option value="Κέρκυρα">
      <option value="Ζάκυνθος">
      <option value="Σαντορίνη">
      <option value="Μύκονος">
      <option value="Χίος">
      <option value="Μυτιλήνη">
      <option value="Κως">
      <option value="Νάξος">
      <option value="Πάρος">
      <option value="Αλεξανδρούπολη">
    </datalist>

    <input type="number" id="min" placeholder="Ελάχιστη τιμή" style="width:140px" min="0"/>
    <input type="number" id="max" placeholder="Μέγιστη τιμή" style="width:140px" min="0"/>
    <button class="btn btn-apply" id="apply">Εφαρμογή</button>
    <button class="btn btn-reset" id="reset">Επαναφορά</button>

    <div class="controls-bottom" style="margin-left:auto">
      <div class="sort-buttons">
        <button id="sort-asc" class="sort-asc">Τιμή ↑</button>
        <button id="sort-desc" class="sort-desc">Τιμή ↓</button>
      </div>
    </div>
  </div>

  <div class="tabs">
    <div class="wrap">
      <button id="tab-all" class="active">Όλες οι Αγγελίες</button>
      <button id="tab-fav">Αγαπημένες</button>
    </div>
  </div>

  <main class="wrap content">
    <section>
      <div id="listings"></div>
      <button id="loadMore" class="load-more" style="display:none">Φόρτωσε περισσότερα</button>
    </section>

    <aside>
      <div id="map"></div>
    </aside>
  </main>

  <!-- Template -->
  <template id="cardTpl">
    <article class="card">
      <div class="imgwrap"><img class="card-img" src="" alt="image"></div>
      <div class="card-body">
        <div class="meta location"></div>
        <h3 class="title"></h3>
        <div class="price"></div>
        <div class="card-actions">
          <a class="view" target="_blank" rel="noopener">Προβολή</a>
          <button class="fav" title="Προσθήκη στα αγαπημένα">♡</button>
        </div>
      </div>
    </article>
  </template>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
  // --------------------------
  // Demo listings (20 items)
  // price MUST be number
  // --------------------------
  const LISTINGS = [
    {"id":1,"title":"Διαμέρισμα 80τμ στο Κέντρο","location":"Αθήνα","price":650,"lat":37.9838,"lng":23.7275,"image":"https://images.unsplash.com/photo-1598928506311-c55ded91a20a","link":"#"},
    {"id":2,"title":"Μονοκατοικία με κήπο","location":"Θεσσαλονίκη","price":850,"lat":40.6401,"lng":22.9444,"image":"https://images.unsplash.com/photo-1600607687939-ce8a6c25118c","link":"#"},
    {"id":3,"title":"Γκαρσονιέρα κοντά στο ΑΠΘ","location":"Θεσσαλονίκη","price":300,"lat":40.6405,"lng":22.9440,"image":"https://images.unsplash.com/photo-1560185127-6ed189bf02f4","link":"#"},
    {"id":4,"title":"Στούντιο στο Κουκάκι","location":"Αθήνα","price":450,"lat":37.9654,"lng":23.7210,"image":"https://images.unsplash.com/photo-1600585154340-be6161a56a0c","link":"#"},
    {"id":5,"title":"Διαμέρισμα με θέα θάλασσα","location":"Βόλος","price":800,"lat":39.3610,"lng":22.9426,"image":"https://images.unsplash.com/photo-1615874959474-d609969a20ed","link":"#"},
    {"id":6,"title":"Ρετιρέ στην Κηφισιά","location":"Αθήνα","price":1800,"lat":38.0333,"lng":23.7878,"image":"https://images.unsplash.com/photo-1600585153837-0f3b3d1c1b87","link":"#"},
    {"id":7,"title":"Διαμέρισμα στο Παγκράτι","location":"Αθήνα","price":700,"lat":37.9765,"lng":23.7420,"image":"https://images.unsplash.com/photo-1600585154147-6c4b0f9e9c12","link":"#"},
    {"id":8,"title":"Μεζονέτα όμορφη","location":"Πανόραμα","price":1200,"lat":40.6958,"lng":22.9871,"image":"https://images.unsplash.com/photo-1600585154345-78a0f33cb5d2","link":"#"},
    {"id":9,"title":"Στούντιο στην Καμάρα","location":"Θεσσαλονίκη","price":280,"lat":40.6400,"lng":22.9400,"image":"https://images.unsplash.com/photo-1600585154456-5c3b2a1c5e53","link":"#"},
    {"id":10,"title":"Διαμέρισμα στην Καλαμαριά","location":"Θεσσαλονίκη","price":850,"lat":40.6090,"lng":22.9719,"image":"https://images.unsplash.com/photo-1600585154567-89b3c2d3f7c6","link":"#"},
    {"id":11,"title":"Σπίτι στη Γλυφάδα","location":"Αθήνα","price":2500,"lat":37.8696,"lng":23.7500,"image":"https://images.unsplash.com/photo-1600585154678-56b4c1a1b2e4","link":"#"},
    {"id":12,"title":"Γκαρσονιέρα στην Τριανδρία","location":"Θεσσαλονίκη","price":320,"lat":40.6485,"lng":22.9580,"image":"https://images.unsplash.com/photo-1600585154789-32f4c3d4c5b8","link":"#"},
    {"id":13,"title":"Μεζονέτα στη Βούλα","location":"Αθήνα","price":2200,"lat":37.8330,"lng":23.8160,"image":"https://images.unsplash.com/photo-1600585154900-77b3f3f3a5a6","link":"#"},
    {"id":14,"title":"Διαμέρισμα στην Πάτρα","location":"Πάτρα","price":500,"lat":38.2466,"lng":21.7346,"image":"https://images.unsplash.com/photo-1600585155011-88c4f4f4b6a7","link":"#"},
    {"id":15,"title":"Στούντιο στα Εξάρχεια","location":"Αθήνα","price":270,"lat":37.9859,"lng":23.7284,"image":"https://images.unsplash.com/photo-1600585155122-99d5f5f5c7b8","link":"#"},
    {"id":16,"title":"Μονοκατοικία στην Πυλαία","location":"Θεσσαλονίκη","price":1400,"lat":40.6407,"lng":22.9536,"image":"https://images.unsplash.com/photo-1600585155233-a6e6f6f6d8c9","link":"#"},
    {"id":17,"title":"Διαμέρισμα στην Ξάνθη","location":"Ξάνθη","price":400,"lat":41.1362,"lng":24.8880,"image":"https://images.unsplash.com/photo-1600585155344-b7f70707e9da","link":"#"},
    {"id":18,"title":"Ρετιρέ στην Καβάλα","location":"Καβάλα","price":1100,"lat":40.9396,"lng":24.4018,"image":"https://images.unsplash.com/photo-1600585155455-c8f81818facb","link":"#"},
    {"id":19,"title":"Διαμέρισμα στη Λάρισα","location":"Λάρισα","price":350,"lat":39.6390,"lng":22.4191,"image":"https://images.unsplash.com/photo-1600585155566-d9f92929gbcc","link":"#"},
    {"id":20,"title":"Διαμέρισμα στη Σαντορίνη","location":"Σαντορίνη","price":950,"lat":36.3932,"lng":25.4615,"image":"https://images.unsplash.com/photo-1600585155677-e0fa3a3a0cdd","link":"#"}
  ];

  // --------------------------
  // Variables & settings
  // --------------------------
  const PAGE_SIZE = 6;
  let currentCount = 0;
  let currentFiltered = []; // array after filter/sort/tab
  const FAV_KEY = 'easyrent_favs_v1';

  // Map setup
  const map = L.map('map', { preferCanvas: true }).setView([38.0, 23.7], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  let markerGroup = L.layerGroup().addTo(map);

  // Helpers
  const loadFavorites = () => {
    try { return JSON.parse(localStorage.getItem(FAV_KEY) || '[]'); }
    catch (e) { return []; }
  };
  const saveFavorites = arr => localStorage.setItem(FAV_KEY, JSON.stringify(arr));
  const isFav = id => loadFavorites().includes(id);

  function normalizeStr(s){
    if(!s) return '';
    return String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  }

  // Initial actions on DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    // Wire buttons
    document.getElementById('apply').addEventListener('click', applyFilters);
    document.getElementById('reset').addEventListener('click', resetFilters);
    document.getElementById('tab-all').addEventListener('click', () => { setTab('all'); });
    document.getElementById('tab-fav').addEventListener('click', () => { setTab('fav'); });
    document.getElementById('sort-asc').addEventListener('click', () => sortAndRender('asc'));
    document.getElementById('sort-desc').addEventListener('click', () => sortAndRender('desc'));
    document.getElementById('loadMore').addEventListener('click', loadMore);

    // initial load:
    currentCount = 0;
    applyFilters(true); // load everything initially
  });

  // Apply filters + update currentFiltered
  function applyFilters(skipRender=false){
    const qRaw = document.getElementById('q').value || '';
    const q = normalizeStr(qRaw);
    let min = Number(document.getElementById('min').value);
    let max = Number(document.getElementById('max').value);
    if (isNaN(min) || min < 0) min = 0;
    if (isNaN(max) || max < 0) max = Infinity;

    currentFiltered = LISTINGS.filter(it => {
      const price = Number(it.price) || 0;
      if (price < min || price > max) return false;
      const hay = normalizeStr(it.title + ' ' + it.location);
      return !q || hay.includes(q);
    });

    // If tab fav => filter favorites
    if (document.getElementById('tab-fav').classList.contains('active')) {
      const favs = loadFavorites();
      currentFiltered = currentFiltered.filter(it => favs.includes(it.id));
    }

    // reset pagination
    currentCount = 0;
    if (!skipRender) renderPaginated();
    else renderPaginated();
  }

  // Reset filters UI
  function resetFilters(){
    document.getElementById('q').value='';
    document.getElementById('min').value='';
    document.getElementById('max').value='';
    // remove fav tab selection if any
    document.getElementById('tab-all').classList.add('active');
    document.getElementById('tab-fav').classList.remove('active');
    applyFilters();
  }

  // Set active tab
  function setTab(t){
    if (t === 'all') {
      document.getElementById('tab-all').classList.add('active');
      document.getElementById('tab-fav').classList.remove('active');
    } else {
      document.getElementById('tab-fav').classList.add('active');
      document.getElementById('tab-all').classList.remove('active');
    }
    applyFilters();
  }

  // Sorting helpers
  function sortAndRender(direction){
    if (direction === 'asc') {
      currentFiltered.sort((a,b)=> Number(a.price) - Number(b.price));
    } else {
      currentFiltered.sort((a,b)=> Number(b.price) - Number(a.price));
    }
    // reset pagination and render
    currentCount = 0;
    renderPaginated();
  }

  // Pagination: render slice and show Load more
  function renderPaginated(){
    const wrap = document.getElementById('listings');
    wrap.innerHTML = '';
    if (!currentFiltered || currentFiltered.length === 0){
      document.getElementById('loadMore').style.display='none';
      wrap.innerHTML = '<div class="msg">Δεν υπάρχουν διαθέσιμες αγγελίες.</div>';
      updateMapMarkers([]);
      return;
    }
    // increment count if zero
    if (currentCount === 0) currentCount = Math.min(PAGE_SIZE, currentFiltered.length);
    const slice = currentFiltered.slice(0, currentCount);
    const tpl = document.getElementById('cardTpl');

    slice.forEach(it => {
      const node = tpl.content.cloneNode(true);
      node.querySelector('.card-img').src = it.image || 'https://via.placeholder.com/800x400?text=No+Image';
      node.querySelector('.card-img').alt = it.title;
      node.querySelector('.location').innerText = it.location || '';
      node.querySelector('.title').innerText = it.title || '';
      node.querySelector('.price').innerText = (Number(it.price) || 0) + ' €';
      node.querySelector('.view').href = it.link || '#';
      const favBtn = node.querySelector('.fav');
      favBtn.innerText = isFav(it.id) ? '♥' : '♡';
      favBtn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        toggleFav(it.id, favBtn);
      });
      wrap.appendChild(node);
    });

    // load more visibility
    if (currentCount < currentFiltered.length) {
      document.getElementById('loadMore').style.display = 'block';
      document.getElementById('loadMore').innerText = `Φόρτωσε περισσότερα (${currentFiltered.length - currentCount})`;
    } else {
      document.getElementById('loadMore').style.display = 'none';
    }

    // update map to show only currently shown slice (or all filtered - choose behavior)
    // we'll show markers for CURRENT FILTERED (not only slice) for better UX
    updateMapMarkers(currentFiltered);

    // optionally, fit map to markers
    fitMapToMarkers(currentFiltered);
  }

  function loadMore(){
    currentCount = Math.min(currentFiltered.length, currentCount + PAGE_SIZE);
    renderPaginated();
  }

  // toggle favorite
  function toggleFav(id, btnEl){
    const favs = loadFavorites();
    let newFavs;
    if (favs.includes(id)) {
      newFavs = favs.filter(x=> x !== id);
      btnEl.innerText = '♡';
    } else {
      newFavs = [...favs, id];
      btnEl.innerText = '♥';
    }
    saveFavorites(newFavs);
    // if currently showing favorites tab, re-render to remove item if unfavorited
    if (document.getElementById('tab-fav').classList.contains('active')) applyFilters();
  }

  // Map markers update
  function updateMapMarkers(data){
    markerGroup.clearLayers();
    if (!data || data.length === 0) return;
    data.forEach(it => {
      if (it.lat && it.lng){
        const m = L.marker([it.lat, it.lng]);
        m.bindPopup(`<strong>${escapeHtml(it.title)}</strong><br>${escapeHtml(it.location)}<br><b>${Number(it.price)} €</b>`);
        markerGroup.addLayer(m);
      }
    });
  }

  // Fit map to current filtered markers (if any)
  function fitMapToMarkers(data){
    const latlngs = data.filter(it=>it.lat && it.lng).map(it=>[it.lat, it.lng]);
    if (latlngs.length === 0){
      map.setView([38.0,23.7],6);
    } else if (latlngs.length === 1){
      map.setView(latlngs[0], 12);
    } else {
      const bounds = L.latLngBounds(latlngs);
      map.fitBounds(bounds, {padding:[40,40]});
    }
  }

  // Utility to escape HTML in popups (small)
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];});
  }

  // initial apply on load (make currentFiltered default)
  // applyFilters(); // already called in DOMContentLoaded

  </script>
</body>
</html>

